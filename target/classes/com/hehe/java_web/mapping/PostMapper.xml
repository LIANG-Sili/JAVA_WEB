<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hehe.java_web.dao.IPostDao">

    <resultMap id="BaseResultMap" type="com.hehe.java_web.pojo.Post">
        <id column="PID" property="PID" jdbcType="INTEGER"/>
        <result column="PBelongPostID" property="PBelongPostID" jdbcType="INTEGER"/>
        <result column="PContents" property="PContents" jdbcType="TEXT"/>
        <result column="PTimes" property="PTimes" jdbcType="VARCHAR"/>
        <result column="PFlag" property="PFlag" jdbcType="INTEGER"/>
        <result column="PType" property="PType" jdbcType="INTEGER"/>
        <result column="PBelongUserID" property="PBelongUserID" jdbcType="INTEGER"/>
    </resultMap>

    <!--获取所有贴子-->
    <select id="selectPostAll" resultMap="BaseResultMap">
      SELECT * FROM Post
      ORDER BY PID
      LIMIT #{offset}, #{limit}
  </select>

    <!--获取他所依赖的贴子-->
    <select id="selectBelongPost" resultMap="BaseResultMap">
      SELECT * FROM Post
      WHERE PID = #{PBelongPostID,jdbcType = INTEGER}
  </select>

    <!--获取一个用户发起的所有贴子-->
    <select id="selectUserPostAll" resultMap="BaseResultMap">
      SELECT * FROM Post
      where PBelongUserID = #{user.UID,jdbcType = INTEGER}
      ORDER BY PID
      LIMIT #{offset}, #{limit}
  </select>


    <!--获取这个贴子的所有子贴-->
    <select id="selectUserPostAll" resultMap="BaseResultMap">
      SELECT * FROM Post
      where PBelongPostID = #{post.PID,jdbcType = INTEGER}
      ORDER BY PID
      LIMIT #{offset}, #{limit}
  </select>

    <!--插入一个贴子-->
    <insert id="insertPost" parameterType="com.hehe.java_web.pojo.Post">
    INSERT INTO Post
    VALUES (default ,#{PBelongPostID, jdbcType=INTEGER}, #{PContents, jdbcType=TEXT},
    #{PTimes, jdbcType=VARCHAR},#{PFlag, jdbcType=INTEGER},#{PType, jdbcType=INTEGER}
    #{PBelongUserID,jdbcType=INTEGER})
  </insert>

    <!--更新一个贴子-->
    <update id="updatePost" parameterType="com.hehe.java_web.pojo.Post">
        UPDATE Post
        <set>
            <if test="PTimes != null and PTimes != ''">
                PTimes = #{PTimes, jdbcType=VARCHAR},
            </if>
            <if test="PContents != null and PContents != ''">
                PContents = #{PContents, jdbcType=TEXT},
            </if>
            <if test="PEmail != null and PEmail != ''">
                PEmail = #{PEmail, jdbcType=VARCHAR},
            </if>
            <if test="PScore != null and PScore != ''">
                PScore = #{PScore, jdbcType=INTEGER},
            </if>
        </set>
        WHERE PUserName = #{PUserName, jdbcType=VARCHAR}
    </update>


    <!--删除一个贴子-->
    <delete id="deletePost" parameterType="com.hehe.java_web.pojo.Post">
    DELETE FROM Post
    WHERE PID = #{PID, jdbcType=INTEGER}
  </delete>

    <!--获取这个贴子所属的标签-->
    <select id="selectPostBelongLabelAll" resultMap="BaseResultMap">
      select *
        from Label
        where LID in
        (select LID
            from PostBelongLabel
            where PID = #{post.PID,jdbcType = INTEGER})
        order by LID
        LIMIT #{offset}, #{limit}
    </select>

    <!--获取关注这个贴子的人-->
    <select id="selectUserCollectPostAll" resultMap="BaseResultMap">
      select *
        from User
        where UID in
        (select UID
            from UserCollectionPost
            where PID = #{post.PID,jdbcType = INTEGER})
        order by UID
        LIMIT #{offset}, #{limit}
  </select>

    <!--增加贴子的标签-->
    <insert id="insertPostBelongLabel">
    INSERT INTO PostBelongLabel
    VALUES (#{label.LID, jdbcType=INTEGER},#{post.PID, jdbcType=INTEGER})
  </insert>

    <!--删除贴子的标签-->
    <delete id="deletePostBelongLabel">
    delete from PostBelongLabel
    where (#{post.PID, jdbcType=INTEGER},#{label.LID, jdbcType=INTEGER})
  </delete>

</mapper>